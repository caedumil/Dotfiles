#!/bin/bash

monitors=$(bspc query -M | wc -l)

while read -r line; do
    case ${line} in
        C*) #clock output
            clock="${line#?}"
            ;;
        S*) #system information
            sys="${line#?}"
            ;;
        W*) #bspwm internal state
            wm=""
            IFS=":"
            set -- ${line#?}
            while [ $# -gt 0 ]; do
                item=${1}
                name=${item#?}
                case ${item} in
                    [mM]*)
                        [[ ${monitors} -lt 2 ]] && shift && continue
                        case ${item} in
                            M*)
                                # focused monitor
                                icon=" \uE1D7 "
                                fg="#FF$(getXresColor foreground)"
                                bg="-"
                                ul="-"
                                ;;
                            m*)
                                # monitor
                                icon=" \uE1D7 "
                                fg="#FF$(getXresColor brightblack)"
                                bg="-"
                                ul="-"
                                ;;
                        esac
                        wm+="%{B${bg}}%{F${fg}}%{U${ul}}${icon}%{U-}%{F-}%{B-}"
                        ;;
                    [fFoOuU]*)
                        case ${item} in
                            [FOU]*)
                                # focused desktop
                                icon="%{+o} \uE190 %{-o}"
                                fg="#FF$(getXresColor foreground)"
                                bg="-"
                                ul="${fg}"
                                ;;
                            f*)
                                # free desktop
                                icon=" \uE190 "
                                fg="#FF$(getXresColor brightblack)"
                                bg="-"
                                ul="-"
                                ;;
                            o*)
                                # occupied desktop
                                icon=" \uE190 "
                                fg="#FF$(getXresColor foreground)"
                                bg="-"
                                ul="-"
                                ;;
                            u*)
                                # urgent desktop
                                icon=" \uE190 "
                                fg="#FF$(getXresColor red)"
                                bg="-"
                                ul="-"
                                ;;
                        esac
                        wm+="%{B${bg}}%{F${fg}}%{U${ul}}${icon}%{U-}%{F-}%{B-}"
                        ;;
                    [LTG]*)
                        # layout, state and flags
                        wm+=""
                        ;;
                esac
                shift
            done
            ;;
    esac

    printf "%b\n" "%{l}${clock} %{c}${wm} %{r}${sys}"
done
